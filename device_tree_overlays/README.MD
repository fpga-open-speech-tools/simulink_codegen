# DTOGen: Autogen Device Tree Overlay Generator  

DTOGen generates Linux device tree source files for use with the [device tree compiler](https://git.kernel.org/pub/scm/utils/dtc/dtc.git/).

## Usage 
```
generate.py [-h] [-s SOPCINFO] [-r RBF] [-o OUTPUT_DIR]
```
Example usage:
```
python generate.py -s de10_system.sopcinfo -r de10.rbf -o "../outputDir/here"
```

The output device tree source file always has a matching name to the rbf filename, thus `de10.rbf` will yield `de10.dts` 

Note: Use a path to the sopcinfo file, but only use the filename for the rbf. This is because the rbf file is not read, the filename is a part of device tree overlay.

### Compiling the Device Tree source files
Device Tree source files generated by this utility must still be compiled for use. That can be done using the dtc command made available by installing the  [Device Tree Compiler](https://git.kernel.org/pub/scm/utils/dtc/dtc.git).  

dtc installation on Ubuntu
```
sudo apt-get install device-tree-compiler
```
dtc installation using a [script](https://github.com/beagleboard/bb.org-overlays/blob/master/dtc-overlay.sh)
```
wget https://raw.githubusercontent.com/beagleboard/bb.org-overlays/master/dtc-overlay.sh
chmod +x dtc-overlay.sh
sudo ./dtc-overlay.sh
```
A benefit of using the script is being able to select a version of dtc, including version's more recent than Ubuntu's available package. Simply update the `git_tag=` line `dtc-overlay.sh` to the version you want installed.  

Supported dtc versions:
1.4.6 and newer

Example dtc usage  
```
dtc -O dtb -o de10.dtbo de10.dts
```
- `-O dtb` sets the output type to be a device tree blob
- `-o de10.dtbo` sets the output filename to de10.dtbo where dtbo is used conventionally for overlays over regularly blobs that go with dtb.
- `de10.dts` is the input device tree source file that would be generated by this utility


## Example Generated File

For in-depth explanations on device tree source files, read documentation [here](https://elinux.org/Device_Tree_Usage).

```
/dts-v1/;
/plugin/;

&base_fpga_region {
	firmware-name = "de10.rbf";
	
	#address-cells = <2>;
	#size-cells = <1>;
	ranges = <0x00000001 0x00000020 0xff200020 0x00000010>;
	
	echo_0: echo@100000020 {
		compatible = "fe,echo-1.0", "dev,fe-echo";
		reg = <0x00000001 0x00000020 0x00000010>;
	};
	
	
};
```
The initial section declares it as as dts file and the plugin line makes it an overlay: 
```
/dts-v1/;
/plugin/;
```

The fpga region to attach the overlay to:
```
&base_fpga_region {
```

The  rbf file to program the fpga with:
```
	firmware-name = "de10.rbf";
```

The address-cells field is set 2 to enable addressing by first the FPGA bridge, then the offset and size-cells is 1 for the length property to be a single value.
```
    #address-cells = <2>;
	#size-cells = <1>;
```

A mapping from the local addressing used in child nodes to the system's address space:
Memory mapping of the echo node on bridge `0x1`, with an offset of `0x20`, resulting in a translated address of `0xff200020`, and has a length of `0x10`
```
    ranges = <0x00000001 0x00000020 0xff200020 0x00000010>;
```

Defines an `echo` node with label `echo_0` with a unit name of `1` and offset of `20`.
The compatible property defines the exact device this is as well as the generic device for loading of device drivers. The reg property defines what bridge this mapped on, the offset, and the length.
```
	echo_0: echo@100000020 {
		compatible = "fe,echo-1.0", "dev,fe-echo";
		reg = <0x00000001 0x00000020 0x00000010>;
	};
```

